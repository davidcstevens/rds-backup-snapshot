#!/bin/bash

function usage() {
	echo
	echo "THESE NEED TO BE UPDATED BASED ON RESULTING CODE"
	echo
	echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
	echo "@@    @@@     @@@@    @@@     @@@  @@  @@"
	echo "@@  @  @@  @@  @@  @@@ @@  @@  @@  @@  @@"
	echo "@@    @@@  @@  @@@@  @@@@     @@@  @@  @@"
	echo "@@  @ @@@  @@  @@ @@@  @@  @@  @@  @@  @@"
	echo "@@  @@ @@     @@@@    @@@     @@@@    @@@"
	echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
	echo
	echo "   Parameters:"
	echo
	echo "	-h: print this help doc"
	echo
	echo "	-t: set search tag"
	echo
	echo "	-l: list all domains"
	echo
	echo "	-s: list all domains in a single line"
	echo
	echo "	-a: list all instances with details"
	echo
	echo "	-f: specify path and filename for FTP"
	echo
	echo "	-d: specify destination path and filename on the instance"
	echo
	echo "   Examples:"
	echo 
	echo "	To view a list of all Production instances IDs:"
	echo "		rdsbu -t Production -l"
	echo 
	echo "	To FTP a file to the Cron instances:"
	echo "		rdsbu -f /path/to/local/file -d /path/to/destination/directory"
	echo
}

function rdsbu() {
	if [[ $# == "0" ]]; then
		# listsnapshots "-l"
		echo 
		echo "Nothing to do"
		echo "Type 'rdsbu -h' for help"
		echo 
	else
		echo
		switchboard $@
	fi
}

function switchboard() {
	while getopts ":ht:slaf:" optname
	do
		case "$optname" in
			"h")
				usage
				exit
				;;
			"t")
				setid $OPTARG
				;;
			"l" | "s" | "a")
				if [[ -z $listparam ]]; then
					listparam=$optname
				fi
				;;
			"f")
				filepath=$OPTARG
				;;
			"d")
				destination=$OPTARG
				;;
			"?")
				echo "Unknown option $OPTARG"
				;;
			":")
				case "$OPTARG" in
					"f")
						echo "Argument $OPTARG requires a filename"
						exit
						;;
					"t")
						echo "Argument $OPTARG requires a tag name"
						exit
						;;
					*)
						echo "Argument $OPTARG requires a value"
						;;
				esac
				;;
			*)
				# Should not occur
				echo "Nothing to do"
				;;
		esac
		# echo "OPTIND is now $OPTIND"
	done
	if [[ -z $listparam ]] && [[ -z $filepath ]] && [[ -z $destination ]]; then
		usage
		exit 1
	elif [[ $listparam ]]; then
		listsnapshots
	elif [[ $filepath ]] || [[ $destination ]]; then
		sendftp
	else 
		usage
		exit 1
	fi
}

function setid() {
	tag=$1
	echo "Backup id set to '$tag'"
}

function listsnapshots() {
	echo "Getting snapshot details..."
	# data=$(rds-describe-db-snapshots)
	data=$(cat rds-describe-db-snapshots.test.txt) # TEST DATA - CHANGE BEFORE PUBLISHING

	# tags=$(echo "$data" | grep TAG)
	snapshots=$(echo "$data" | grep DBSNAPSHOT)
	ids=(); ## declare array
	while read line; ## gets each instance domain name
	do
		set $line ## $2 = instance tag, $4 = domain name
		echo ${2}
		ids+=(${2})
	done <<< "$snapshots"
	if [[ $listparam == "s" ]]; then
		listfunctions $param
	elif [[ $listparam == "l" ]]; then
		listfunctions $param
	elif [[ $listparam == "a" ]]; then
		listfunctions $param
	fi
	echo
}

function listfunctions() {
	case "$listparam" in
		"l")
			for x in "${domains[@]}"
			do
				echo $x
			done
			;;
		"s")
			echo ${domains[@]}
			;;
		"a")
			for x in "${instances[@]}"
			do
				echo "$x"
			done
			;;
		*)
			echo
			;;
	esac
	echo 
}

rdsbu $@